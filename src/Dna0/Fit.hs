
module Dna0.Fit where

-- internal 
import Dna0.Repr

-- external
import Data.Map
import Data.Maybe (fromJust)
import Control.Monad
import Debug.Trace
import System.Random (uniformRs)

-- the hidden function
-- f(x) = 2x^2 - 3x + 10
-- answer :: Expr
-- answer =
--  Add
--    (Mul
--       (Lit 2)
--       (Pow
--          Inp
--          (Lit 2)))
--    (Add
--       (Neg $ Mul (Lit 3) Inp)
--       (Lit 10))


-- (3/2)x^4 - x^3 + (8/3)x - 26
answer :: Expr
answer =
 Add
   (Mul
      (Mul (Lit 3) (Inv (Lit 2)))
      (Pow Inp (Lit 4)))
   (Neg $ Add
      (Add 
        (Pow Inp (Lit 3))
        (Mul 
            (Mul (Lit 8) (Inv (Lit 3))) 
            Inp))
      (Neg (Lit 26)))

-- (3/2)x^2 - 8x + - 26
-- answer :: Expr
-- answer =
--  Add 
--    (Mul (Mul (Lit 3) (Inv (Lit 2)))
--         (Pow Inp (Lit 2)))
--
--    (Add (Neg (Mul (Lit 8) Inp))
--         (Neg (Lit 26)))

eval :: Expr -> Double -> Maybe Double
eval Inp input      = Just input
eval (Lit x) _input = (Just . fromIntegral) x
eval (Neg e) input = do
  x <- eval e input
  pure (-x)

eval (Inv e) input = do
  x <- eval e input
  if x == 0 then Nothing
    else pure (1/x)

eval (Add el er) input = do
  xl <- eval el input
  xr <- eval er input
  pure (xl + xr)

eval (Mul el er) input = do
  xl <- eval el input
  xr <- eval er input
  pure (xl * xr)

eval (Pow el er) input = do
  xl <- eval el input
  xr <- eval er input
  pure (xl ** xr)


expected :: Map Int Double
expected = fromList [(i, aux i) | i :: Int <- is]
  where 
    aux i = case eval answer (fromIntegral i) of
            Nothing -> trace ("error here! " ++ show i) undefined
            Just x  -> x 
        
-- standart derivation
fitness :: Expr -> Maybe (Expr, Double)
fitness expr = (expr,) . sum . fmap (**2) <$> do 
  forM is $ \i -> do
    out_i <- eval expr (fromIntegral i)
    pure (out_i - expected ! i)


-- x :: [Int]
-- x = uniformRs (-10_000, 10_000) undefined

is :: [Int]
is = is0 -- ++ is2 ++ [-100..100]
is0 = [6584,7818,-6192,-8374,8857,-4658,-4514,-9770,-9050,4479,-4169,-5934,271,-1,2801,8883,-6999,9965,5715,7579,7272,1645,3422,263,-4937,-6088,-6259,-2408,5954,-3218,8900,-7034,-4659,3765,145,5986,-1824,-1457,1638,-6169,-8950,-2346,7373,-8498,-8781,-4884,-6846,-7971,-9017,-1807,2346,3397,-4319,5484,3055,1972,2786,-3712,-957,-6486,2193,-3578,-6952,-2021,-7670,3110,7609,-2632,8956,2628,-3560,-4075,2270,-3827,-5529,-8898,3397,-3675,8559,-8114,8406,2985,-7099,2415,7132,-1473,-8135,-8807,-9745,-884,-4761,4164,-7052,6120,4991,-401,-1775,3908,888,4111,-2740,3786,3247,-2322,6898,5869,9242,-3947,3067,5911,-9950,-3303,7657,-1675,-8274,-6274,-5964,2088,7388,1395,-8329,950,9024,-4054,-4147,2031,3487,8873,-1124,-9166,6840,1415,-2268,2488,-6031,4487,4544,2256,-7149,-8494,4239,4563,8661,-130,-7847,-5409,1699,7444,7646,-9084,6477,-772,6209,6675,9565,-7428,7337,2342,-7865,-6357,-6806,-4492,-748,5881,-1612,6678,8175,698,4273,2647,-4496,3682,-7233,3301,3876,-3088,7360,7245,1945,-9542,-2344,-8896,-3309,-6947,9313,-3580,6386,-3857,-4950,5886,-3869,2899,-958,-2343,-6509,-6987,2894,-561,5190,7820,9383,8083,-1115,1963,-7838,8310,-5955,-3903,9876,4501,7135,-3651,653,-3618,331,7316,5098,-4489,-8597,6692,-7771,-2697,-619,527,4404,-6476,3701,7923,5664,8926,4807,4989,-2310,-9279,3159,1199,8287,5482,-9735,-2681,8832,7210,3291,3610,2826,-4741,3592,-5312,3399,2325,-5021,227,9145,-3428,-7961,370,6824,-9011,-6944,-6040,-3608,-3383,7005,5483,-3233,4702,-2758,7582,9349,-7539,-2507,-7814,-9171,-5421,-322,-4780,-9319,6037,-2406,2348,7331,-8464,1775,591,-2565,7046,3698,-4414,9710,4814,4254,8513,1119,-4457,5410,8985,1726,3553,3412,-5264,9421,-1042,5982,9554,-3601,445,-160,4543,4066,-7244,-2356,6338,10000,1584,401,8226,1723,6165,415,-3464,-1874,2899,-971,1331,-6762,-5610,-3123,-8234,7995,-7119,6933,1481,7082,-3392,-2775,2340,-2952,-5643,4923,-3948,-6553,-9635,9341,4976,4569,264,8211,4271,-3251,-137,-6969,-642,-5463,931,-3702,4990,1956,2477,1625,-1891,445,-5669,-9864,-5914,8819,-8450,-9979,-5895,768,-5157,5529,-7486,4691,-5263,5657,-6483,1149,2026,4906,9790,-9434,-8431,-5519,2456,-1809,1108,-398,27,-1216,2972,7571,4791,-9300,3498,2211,964,4609,7549,-5613,-3115,2714,-1218,1859,8516,9696,7887,-1682,-1378,6133,-1928,2407,3246,-5083,-5188,5079,7788,-708,-6737,-6750,-9707,8991,8896,5216,-9592,7263,8199,-3295,-9976,6403,-4445,3898,-5089,2954,-1184,1589,-7192,-9656,269,-1889,-9884,-8076,-387,4525,5860,229,2340,7045,-116,-8009,-3263,-5701,-1732,-3727,4752,1011,591,1734,-8823,6861,-2909,-4718,-9134,-8939,8376,-4193,34,-116,4499,-7021,9686,-8565,922,-7402,3786,9829,-8908,3333,9207,-3341,-1198,-7883,-1338,-3297,-9403,4534,5060,7278,-4668,-147,4765,8207,7402,8689,-3390,2842,-6311,-4116,-4250,-8478,-6182]

-- is = [-4725964898161447617,5167890605769259741,8435874682154077090,-8746884958459491339,-8894589400591103482,4031581024735525337,1233712447890377428,1408749051929837736,775739431980849795,5531198012021803965,5653645347577426510,3757363656898613048,-1591393918201814471,-8591690562261172264,2875084697477229151,-5779925738436832725,6603815730460152088,5065556990856084215,-6630399683621614637,-7844228629293914475,8645632710275753553,6523098315833463916,7900008260620581407,-2422581763550584897,5555755388476425450,-6719976828009184560,-6745750577479041028,-9048209339720778805,-6158161614425112108,-1316033531922349274,3062085094332627973,1163945362191578585,1651404414753334469,-4715502780996892640,-7642361203547374606,2047365527845298381,-1075750111640126734,-5237649617000087611,-1815529878545803608,-8935957494128073375,-916192002830159186,-7932497358304787121,-4390036590616082256,-7487626766399124367,5852723187773798798,-8549256191473025491,9033264837532007050,-8313459325341061463,112338761554684321,3498533116857173281,3659887961481124837,1616023983043527655,-7331767076886941980,4112182483773873762,-2703408950402703985,-7501059616068500462,6957196284923313382,-665744645446110242,-8624586407396926383,-3659348705922823221,-307364733350562017,3989664698948659638,6440292008909103553,-2225564630782794286,4798212615783740414,4036947560191988170,-2747747704829754490,9009486466119425150,-6090317691619066717,-2562786640946039904,-6904004821915570259,4470973670213544694,8649715682284526102,6993151110176458020,7357314736096656658,-4064410329082200256,-5169434895696390521,8387281234763177727,1257018625854522409,6970687453272968827,2697994030155817536,-3796242714862215244,-6422510070261482271,6892222339866551409,4567349325801653449,-271054660778410918,-414041567596832559,8468617191342979792,-7992607791727494236,1514659636763507406,5069130660451006871,4027814788392182130,-373134821079794581,-649826828035904134,-5287508271288730606,-6330510387828042267,4181534263199968582,8202492299286272077,3556873624132802434,-5997091121188520606,345535980359734591,8203634446895741143,-6636150278816695995,-3967244573160041734,6377254843928382388,1966790579308767175,-6629329214740715513,502849887659093135,-8370669144633651876,-6533354721615594824,4115488651266811813,4769769030618714430,-332441083992251741,2424743784602260073,-4084694320176685419,-7344413088253463364,-8654769199812901916,-4856291477793771683,-5740547973560408942,550031550329074645,5500032364600583900,4347040525011064150,4316123331136432103,428860424072330470,-3376318981344803036,-7435195289247986183,-8655524855511509907,8521662623646002767,-2585273349088556908,1718772530820454460,9166469832340775676,-1829798042894105390,-488238074448423270,8610817079541601245,-2911228432928005172,802920179923593195,454536948913741380,-7782068198661613939,-3999571474783409679,-7126863954613336186,-5892006066187974243,-5767694889882893694,6036708449650940335,-6077228878113225952,-240358338307288865,-4398159567356557718,1776195974486064364,5352243857542412805,-4296775646223131788,-3172444713619390028,-3172133078405382846,5232222550884372538,-8954673930323598063,-2932422010363716099,8131850892487575426,-4281711353216751188,-5813141180450622958,-3048304496261931546,4930002432685654834,-1449024849003433328,3570655454658117457,7595849490623360423,-2611692393453496072,996310896140284675,-3405672375995071766,121205515226615340,-4680056305891007010,-6457848051754393365,660164585919842665,-6890988846616573319,-704900437637299274,-1801249183125148554,-7796122889004628914,6612478871096703462,6793090826876530762,6261164888893505888,-5594548898431489540,-1493386860756263252,75147962962454215,8556677313838686081,-1540056198909725032,5711750454686362238,-5440480590350942497,-2504063709595619695,8101339151589760958,5833236208935317463,-3866722903323715506,9119846221408649242,-434554745519282344,6366837432323588804,-5563657969955161823,-2334653388156507081,-5674222449745882686,-4054211102324844542,-3222478288879115582,-5361860987737516063,-3258682539158710751,3862339071138801414,2146249430780521358,-4338545142926054979,352834113256831354,7922505014538474153,8106548389636326406,-59286229627612185,-3439637828657108600,-3930450821229812188,5569749147027144679,-664118105594159253,-4442651306926228089,-2445423400679453777,-48693466214406373,-2420149561529678098,3895690556845242980,-1225767977880952656,-5457173607667771527,3763782930834860051,-7005059951973819511,-2911304529307931166,-3165540670604213676,8292499773858947590,-3734915995031274776,2555386863677933557,-8120675147005187407,8896381367203985930,-5248112060353041632,8393666710980293423,-9212258143326157539,-294218934666811658,2405130768789777735,-2047731877771500289,-1871989982320952176,-1444722206830566790,1571444762524948851,-4891841911713112905,-8806897745701809839,-3637745127782802026,-3921693309938674004,7798635570312777650,4903822831583455724,3796795476717626014,-4337326325831737451,1959211236829103773,317938344130242632,-775140877252180541,7246791238944120638,-6876552608839653644,-5564782159982041791,-1162353449460227253,-1964525378873394520,-3262386304432445293,-9052702759562426227,-4244556371376092394,5806250891877707164,3916440694968888445,-2527740441925822392,9052838171114533581,4599057288701229797,-6744467610047674909,4034618520164600950,-6202668365670966692,5155452025119028757,-3366519129422449206,2403160231289412114,-3137466404052276776,-2692036625231927362,53412246409462898,-4869610397969065190,1584758487829212692,4662409208798178048,-5433951275043194402,-5990021325094872196,6346622434236576087,6617811385059738642,221890678369391156,4325105251279994650,-3850396492111010052,6087810628843811987,8473350765095664596,-7431221163927796324,6627588628133094621,-1802431329320554369,-5350974222871629389,-153918081775015669,-7456952429119998164,265379600655322924,-6972577046111307079,8097032680622002900,-9077371459376610123,-1471825496313721230,-113324826740308080,-3448838678972992675,1312810116849212090,-3678444183299511213,-8688019250903725531,7501933345030608222,-7387713451628953779,1811410876382264368,7570812539679834197,-6933760389200823475,276888404919355988,4991625818406038413,-4302175166063933009,-9159998084282878770,1650104268631865611,6728041838302396876,2458394614702078962,-3276944542778699004,-5125456215605968716,-6030710305251320110,2804605659689146087,980713970153021681,1140771098011381757,1396623218606763890,-5627504237565212013,-197332230150684839,4450724462543740921,1843705361766844891,2628178635806653209,7551381379428695323,-7211513435277719506,-8432646879793924278,-4912986508141654043,-5791635875966534272,-2168762877734744711,-821670479219288618,-6266169040167255781,8608231003890987852,-488192474288332984,782298369601004609,4100950077823686710,-3770289415571213472,-5784219302092365134,-5926415628068295086,-8143430932713872543,-7086735222239297337,913368346329997145,7116773708098643115,-4113723176403512664,747953923552874258,-9052391621723976929,-5704647429806486522,-191781694037002745,976368115546218576,-6682850923860553914,-8110306700364238071,5738876544892992127,-1220542909095798941,4993735762504710954,-4980989920082765492,976018475583882890,-1891855984436429669,1511394784183214591,2416735698617707711,9032716707164754907,8498361967093488044,5686091892147488171,-4867121445168055811,-3479494183828119364,-695764154540397930,209556384706657501,4563154251884666706,-3599627858907700334,2951752322198122539,-1946695299115962177,-4905620711087143419,-1547355390348634794,-3993147564480656370,-5701424561577463138,-4778443261520657069,1029673381488194016,9006436845519610649,-2604031770836868904,5431160715860509280,-688486389380464495,-3463707347735911147,1609504352953820894,8005043532052177113,-6755216064703152071,-8057103461390637370,5134104896981656567,635688960290199615,8832302132540924655,-302439364511026302,3476434671775044255,-8045773337480053583,-3885396122143708359,-2292609722825062357,-8356222679029787221,-5758599077016061271,219027029706703425,-144199809534404773,8158014278923841461,-7295219484562217156,-207802435740145917,-3272985301388507106,-1284753635286129459,-3636091958515136648,4401214856855413842,-5810264376847571908,-4561648910592994945,-7305667932190039111,-934871731493266390,4858687961512046879,7406352089195366296,6822872622265027129,239146041346010625,9103536003124233851,1160186525090183775,-1516026796088103696,864361957665454692,-5688166289050398165,-8026932566105826260,5191998589262734701,-8395131980259073915,-2507252203797116675,3796831320578222530,-1367351119986070524,-1577742426326401379,4301278810739374176,-5374183716270768759,8828996121090439064,-2258971733758219703,-2827440105620147984,8580316295652340091,-137755433091594005,-1125540373404736170,-3338653203578901988,8045460274171301352,-7769730814201096360,6383222277975515268,6527031331322808263,-4578724987898135526,-3127992448926779042,7239202391529174513,5305968329844320551,-2764682899429984582,-998473305445407642,973410955055736049,-5978309274846564480,-7437401574712914137,-6813695079979967388,-1466690183030335762,-3216701751021721972,-7487243903409917919,5870888454639855046,-5376823142518150602,5535015155163760889,752570185021023765,2793506016522409372,-4204166603793535636,-1244283654284626118,8604663837539087079,1110758459362209065,6855982745331645005,3304507853888556312,-1603575159703833538,-602909439624885004,-6728965626619424626,6385101091898867596,4195143343564405433,3843594775985815688,2137182784832284791,37674037216139698,-9008722276406131406,-2317579451338362590,-1192219580625756091,-2281358890121044131,-9123610964673061560,6211051022675469480,-2407708797947240052,400696471054857796,1520505750510583447,1819452690615362151,2677940150062011204,-4052991326844166055,5096574292824928824,3008243437228250959,-3679414942985144076,7893158417532898280,-774697197037339415,8426966922372352592,5583101719244331928,3670064437103366426,4832497874207671765,8872770234234126753,-268827484007980328,-253501320482017104,-6893250568716742115,-8158758061250921863,-857973967533576174,479480767166343406,4121772382729295306,4387576265737091528,-4165196901695608603,-8705946699388274478,-4376370993796784618,-1126474781885574027,6787481998365170801,-6102391763333597556,7106576129816235349]
--
--


is2 = [-50211,-231,4700,-37289,41696,-9482,-23962,-96912,59194,13894,-21598,-20527,-74031,54913,3661,-4425,52169,-80125,-89591,-51928,-12439,-49039,-124,17128,-31058,39794,77551,87800,23724,-34209,-91442,-4265,-84940,53114,69091,-59139,16008,91010,-31081,-51969,-93986,-78402,-23015,40006,-15755,-58583,87723,69254,-97843,44607,-26587,-92721,-63376,3303,-30353,-18572,-65586,32271,-49246,-57897,44361,-18686,96938,83348,74008,-89837,17914,-19147,-13760,-37021,1610,24313,-84527,-49505,-72892,89763,21389,2586,-12986,-24153,37588,57264,44077,-88241,-60031,37969,-21007,-26312,-67552,-21515,62493,-17181,-16981,59310,-1092,10617,68851,70761,46661,-82676,39526,-80369,-47346,63142,91974,-68298,67027,-67190,-37924,-98519,-46241,26996,73099,81310,27875,30349,-68998,67877,55581,-40911,38548,8922,90320,-84930,-879,-24478,79535,-53845,93923,69837,-66837,-57897,-57196,-15564,-55096,4152,-62247,15585,-78801,-58968,-65617,17520,-51576,76180,-77564,48370,-805,68708,-10530,-97741,77861,75372,4151,-41725,-13046,-82934,18122,48121,18824,16719,12834,-64777,-46016,-46085,15684,-55818,21438,-14305,-53396,-38149,-61231,-45064,75335,-19257,19243,-49011,61633,38692,-14037,-77983,-5971,78448,18478,29521,79170,-9151,-68899,-97918,74818,52758,-95585,-74392,-80774,-97797,-58020,12172,-72806,-51091,-47803,-93994,7765,-69679,94218,38132,-87682,61382,-64194,39363,60564,-33101,80826,57758,17000,92102,80346,92457,-71613,62825,-9229,-38315,658,-81721,54448,45821,27912,85153,-62154,-39606,-66335,-93818,-21046,-63200,69901,-55456,-50992,30446,3937,-71533,-36729,-33616,40512,41566,94359,-2207,-34914,-2318,-7310,-20207,4837,-20041,-36210,81707,-51714,39151,-81640,-49535,-44462,-98215,35919,74137,74618,-73834,39607,-11839,60264,44484,95316,23475,-78683,17191,-83668,-68135,-59159,44618,41523,37178,-35468,-23209,90112,98730,65018,-64733,17602,78291,55664,23540,60908,86911,17554,77087,-62195,25030,-54192,64451,27814,53050,33398,-27571,35019,96233,-94297,11895,8138,-46723,-26906,24049,6871,89680,-9888,91521,-76949,-43659,3508,14540,88613,82657,-27008,15680,-27839,45940,10556,62651,-8764,364,-91704,12505,-81909,-74119,-22741,19771,98623,-23,56541,-87684,-29246,-33369,96256,-73726,-28709,39437,46048,89123,-17713,51257,39274,-13723,79600,60760,-1092,98953,99666,-68714,-22430,-27678,60663,-21877,-56039,-53654,55533,-33896,-59557,22113,-63387,58543,62011,42301,78038,-9837,93915,49630,40857,-98252,-38321,37186,33793,-60675,54396,90582,-30834,-94716,42580,62762,-26877,-61825,-66639,-20125,-40092,79924,47630,-45367,-24520,-71024,-61458,-44110,51425,72449,7933,-61584,-54790,27520,-90285,-43440,91484,58998,488,-71806,-8222,82098,-28959,71381,76305,-68525,51882,15362,-97623,31437,-23540,-95722,-80442,27033,52478,-99137,3083,75039,96866,68829,-90044,23109,71256,73788,1117,62849,-96353,80432,72979,-19181,-62131,-40182,-14606,-46216,96654,75357,-79485,-61901,-97886,-36379,-90642,67067,-77326,58981,-71454,99363,-9718,61799,-62246,13796,25516,12905,67389,81123,785,-31017,-49192,77052,60908,58419,-91722,4263,-18211,99328,-63237,-40839,25043,-35675,-71917,21365,-18164,75145,79265,-26237,-46115,-31416,64425,-45919,79281,37407,-42553,-68998,-8423,-25196,61320,-39917,-88228,12094,-33225,6666,-26167,72711,-92308,-5175]
